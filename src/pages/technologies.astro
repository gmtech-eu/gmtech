---
import TechnologySlideshow from '@common/TechnologySlideshow.svelte';
import BaseLayout from '@layout/BaseLayout.astro';
import Icon from '@ui/icons/Icon.astro';
import type { Thing, WithContext } from 'schema-dts';

// Import CMS data
import technologiesHeroData from '@data/technologiesHero.json';
import technologiesListData from '@data/technologies.json';
import technologiesCTAData from '@data/technologiesCTA.json';
import { getImage } from 'astro:assets';

// Process images from CMS paths
const processedTechnologies = await Promise.all(
  technologiesListData.technologies.map(async (tech) => {
    const processedImages = await Promise.all(
      tech.images.map(async (img) => {
        try {
          // Dynamically import the image
          const imageModule = await import(/* @vite-ignore */ img.src.replace('@assets', '/src/assets'));
          const optimizedImage = await getImage({ src: imageModule.default, format: 'webp' });
          return {
            src: optimizedImage.src,
            alt: img.alt
          };
        } catch (error) {
          console.error(`Failed to load image: ${img.src}`, error);
          return img; // Return original if import fails
        }
      })
    );
    
    return {
      ...tech,
      images: processedImages
    };
  })
);

// Use processed data
const technologiesData = {
  title: technologiesHeroData.title,
  description: technologiesHeroData.description,
  technologies: processedTechnologies
};

const ctaData = technologiesCTAData;

// SEO metadata for the page
const seo = {
  title: 'Technologies - GMTEC',
  description:
    "Discover GMTEC's expertise in automotive technologies including powertrain, chassis, interior parts, and thermal management solutions.",
};

// Schema.org metadata for SEO
const schema: WithContext<Thing> = {
  '@context': 'https://schema.org',
  '@type': 'WebPage',
  inLanguage: 'en-US',
  '@id': Astro.url.href,
  url: Astro.url.href,
  name: 'Technologies - GMTEC',
  description:
    "Explore GMTEC's comprehensive automotive technology expertise spanning powertrain, chassis, interior parts, and thermal management.",
  isPartOf: {
    '@type': 'WebSite',
    url: `${Astro.site}`,
    name: 'GMTEC',
    description: 'GMTEC Group is a consulting company providing expertise in the Automotive sector since 2003.',
  },
};
---

<BaseLayout seo={seo} schema={schema}>
  <section class="mx-auto max-w-[85rem] px-4 pt-48 pb-12 sm:px-6 lg:px-8">
    <div class="max-w-7xl">
      <div class="mx-auto max-w-3xl text-center lg:mb-14">
        <h1 class="text-4xl text-balance text-slate-800 sm:text-5xl md:text-6xl lg:text-7xl">
          {technologiesData.title}
        </h1>
        <p class="mt-8 text-lg font-medium text-pretty text-slate-700 sm:text-xl/8">
          {technologiesData.description}
        </p>
      </div>
    </div>
  </section>

  {/* Technologies Grid Section */}
  <section class="mx-auto max-w-[85rem] px-4 pb-24 sm:px-6 lg:px-8 lg:pb-32">
    <div class="space-y-16">
      {
        technologiesData.technologies.map((tech, index) => (
          <div class="grid grid-cols-1 items-center gap-8 lg:grid-cols-2 lg:gap-12">
            <div class={`${index % 2 === 1 ? 'lg:order-2' : ''}`}>
              <div class="flex items-start gap-4">
                <div class="flex size-12 shrink-0 items-center justify-center rounded-xl bg-teal-400 text-white">
                  <Icon name={tech.icon} class="size-6" />
                </div>
                <div class="flex-1">
                  <h3 class="text-2xl font-semibold text-slate-800">{tech.title}</h3>
                  <p class="mt-2 text-slate-600">{tech.description}</p>
                  <ul class="mt-4 space-y-2">
                    {tech.features.map((feature) => (
                      <li class="flex items-start gap-2 text-sm text-slate-600">
                        <Icon name="check" class="size-4 shrink-0 text-teal-600" />
                        <span>{feature}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
            <div class={`${index % 2 === 1 ? 'lg:order-1' : ''}`}>
              <TechnologySlideshow images={tech.images} title={tech.title} client:load />
            </div>
          </div>
        ))
      }
    </div>
  </section>

  {/* Call to Action Section */}
  <section class="mx-auto max-w-[85rem] px-4 pb-24 sm:px-6 lg:px-8 lg:pb-32">
    <div class="relative rounded-3xl bg-teal-200 p-8 text-center sm:p-12">
      <h2 class="text-2xl font-semibold text-balance text-slate-800 md:text-3xl">{ctaData.title}</h2>
      <p class="mt-4 text-lg text-pretty text-slate-700">
        {ctaData.description}
      </p>
      <div class="mt-8">
        <a
          href={ctaData.button.href}
          class="inline-flex items-center rounded-xl bg-teal-600 px-6 py-3 text-base font-medium text-white shadow-sm transition-all duration-150 hover:bg-teal-700 focus:bg-teal-700 focus:outline-hidden"
        >
          {ctaData.button.text}
          <Icon name="chevronRight" class="ml-2 size-5" />
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
